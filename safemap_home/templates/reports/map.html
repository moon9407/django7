{% extends 'base.html' %}
{% block title %}SafeMap | ì§€ë„{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}
{% block content %}
<div class="grid grid-2">
  <div class="card">
    <h2 style="margin:0 0 8px;">ì•ˆì „ ì§€ë„</h2>
    <div class="small">ìµœê·¼ ê¸°ê°„ í•„í„°ë¡œ ì‚¬ê±´Â·ì‚¬ê³ ë¥¼ ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤.</div>
    <div class="btnrow" style="margin-top:12px;">
      <button class="btn" onclick="loadMarkers(7)">ìµœê·¼ 7ì¼</button>
      <button class="btn" onclick="loadMarkers(30)">ìµœê·¼ 30ì¼</button>
      <a class="btn primary" href="{% url 'reports:new' %}">+ ì œë³´</a>
    </div>
    <hr>
    <div class="small" id="stat"></div>
    <div class="small" style="margin-top:10px;">íŒ: ë§ˆì»¤ í´ë¦­í•˜ë©´ ìƒì„¸ë¡œ ì´ë™.</div>
  </div>
  <div class="card" style="padding:0;overflow:hidden;">
    <div id="map" style="height:520px;"></div>
  </div>
</div>

<script>
let map = L.map('map').setView([37.5665, 126.9780], 12); // Seoul default
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let layer = L.layerGroup().addTo(map);

function iconFor(item){
  // simple emoji marker via divIcon
  let emoji = "âš ï¸";
  if(item.category === "violence") emoji = "ğŸš¨";
  else if(item.category === "fire") emoji = "ğŸ”¥";
  else if(item.category === "traffic") emoji = "ğŸš—";
  else if(item.category === "lost") emoji = "ğŸ§³";
  let html = `<div style="font-size:22px;transform:translate(-8px,-12px)">${emoji}</div>`;
  return L.divIcon({html: html, className: '', iconSize: [20,20]});
}

async function loadMarkers(days){
  layer.clearLayers();
  const res = await fetch(`/reports/api/list/?days=${days}`);
  const data = await res.json();
  document.getElementById("stat").innerText = `í‘œì‹œì¤‘: ${data.count}ê±´ (ìµœê·¼ ${days}ì¼)`;
  data.items.forEach(item => {
    const m = L.marker([item.lat, item.lng], {icon: iconFor(item)}).addTo(layer);
    const html = `
      <div style="max-width:260px">
        <div><b>${item.title}</b></div>
        <div style="font-size:12px;opacity:.85;margin-top:4px">${item.summary}</div>
        <div style="margin-top:8px"><a href="${item.detail_url}">ìƒì„¸ ë³´ê¸° â†’</a></div>
      </div>`;
    m.bindPopup(html);
  });
}
loadMarkers(7);
</script>
{% endblock %}
